<!doctype html>
if(pond_site!==null && pond_site!=='') patch.pond_site = pond_site;
if(status!==null && status!=='') patch.status = status;
if(Object.keys(patch).length===0) return;
const { error } = await supabase.from('app.submissions').update(patch).eq('id', id);
if(error) alert(error.message); else loadAll();
});
});
}


// Supervisor: Verify Results (approve reports)
async function loadVerify(){
const { data, error } = await supabase.from('app.reports')
.select('id, report_code, status, approved_at, submission_id')
.is('approved_at', null)
.order('created_at', { ascending:false }).limit(200);
if(error){ $('#verify').textContent = error.message; return; }
if(!data?.length){ $('#verify').innerHTML = '<div class="muted">Tidak ada report untuk diverifikasi.</div>'; return; }
const rows = data.map(r=>
`<tr>
<td>${r.report_code}</td>
<td>${r.status}</td>
<td><button class="btn btn-approve" data-id="${r.id}">Approve</button></td>
</tr>`).join('');
$('#verify').innerHTML = `<table><tr><th>Report</th><th>Status</th><th>Aksi</th></tr>${rows}</table>`;
document.querySelectorAll('.btn-approve').forEach(btn=>{
btn.addEventListener('click', async (e)=>{
const id = e.currentTarget.getAttribute('data-id');
const u = (await supabase.auth.getUser()).data.user;
const { error } = await supabase.from('app.reports').update({ approved_by: u.id, approved_at: new Date().toISOString(), status: 'COMPLETED' }).eq('id', id);
if(error) alert(error.message); else loadVerify();
});
});
}


// Navigation hooks
document.querySelector('[data-page="users"]').addEventListener('click', loadUsers);
document.querySelector('[data-page="all"]').addEventListener('click', loadAll);
document.querySelector('[data-page="verify"]').addEventListener('click', loadVerify);


// Boot flow
async function boot(){
const { data: { session } } = await supabase.auth.getSession();
if(!session){ show('login'); $('#top-user').textContent=''; return; }
const user = session.user;
const profile = await getProfile(user.id);
$('#top-user').textContent = (profile?.full_name||user.email||'') + ' (' + (profile?.role||'submitter') + ')';
$('#role').textContent = profile?.role || 'submitter';
show('dashboard');
await renderMine(user);
if(profile?.role==='supervisor' || profile?.role==='admin'){
$('#supervisor-block').style.display='block';
} else {
$('#supervisor-block').style.display='none';
}
}


await boot();
</script>
</body>
</html>
